<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Chat - Admin</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="admin-container">
        <!-- Admin Login -->
        <div id="admin-login" class="modal">
            <div class="modal-content animate-slide-up">
                <h2>Admin Login</h2>
                <input type="password" id="admin-password" placeholder="Enter admin password">
                <button id="login-admin" class="btn">Login</button>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div class="admin-dashboard hidden">
            <header class="admin-header">
                <h2>Admin Dashboard</h2>
                <button id="logout-admin" class="btn logout-btn">Logout</button>
            </header>

            <nav class="admin-nav">
                <button class="nav-btn active" data-section="chat-section"><i class="fas fa-comments"></i> Chat</button>
                <button class="nav-btn" data-section="settings-section"><i class="fas fa-cog"></i> Settings</button>
                <button class="nav-btn" data-section="accounts-section"><i class="fas fa-users"></i> Accounts</button>
            </nav>

            <div class="admin-content">
                <!-- Chat Section -->
                <div id="chat-section" class="content-section active">
                    <div class="admin-chat-messages" id="admin-chat-messages">
                        <!-- Messages will be loaded here -->
                    </div>
                    <div class="admin-chat-controls">
                        <input type="text" id="admin-message-input" placeholder="Type a message...">
                        <button id="admin-send-btn" class="btn send-btn"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settings-section" class="content-section">
                    <div class="settings-form">
                        <div class="form-group">
                            <label for="group-name-input">Group Name</label>
                            <input type="text" id="group-name-input" placeholder="Enter group name">
                        </div>
                        <div class="form-group">
                            <label for="group-profile-url">Group Profile URL</label>
                            <input type="text" id="group-profile-url" placeholder="Enter profile image URL">
                        </div>
                        <div class="form-group">
                            <label>Chat Status</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="chat-status" value="open" checked> Open
                                </label>
                                <label>
                                    <input type="radio" name="chat-status" value="closed"> Closed
                                </label>
                            </div>
                        </div>
                        <button id="save-settings" class="btn save-btn">Save Settings</button>
                    </div>
                </div>

                <!-- Accounts Section -->
                <div id="accounts-section" class="content-section">
                    <div class="accounts-header">
                        <h3>User Accounts</h3>
                        <div class="search-box">
                            <input type="text" id="search-accounts" placeholder="Search users...">
                            <i class="fas fa-search"></i>
                        </div>
                    </div>
                    <div class="accounts-stats">
                        <div class="stat-card">
                            <h4>Total Users</h4>
                            <p id="total-users">0</p>
                        </div>
                        <div class="stat-card">
                            <h4>Active Today</h4>
                            <p id="active-users">0</p>
                        </div>
                        <div class="stat-card">
                            <h4>Banned Users</h4>
                            <p id="banned-users">0</p>
                        </div>
                    </div>
                    <div class="accounts-list" id="accounts-list">
                        <!-- User accounts will be listed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ban Modal -->
    <div id="ban-modal" class="modal">
        <div class="modal-content animate-slide-up">
            <h2>Ban User</h2>
            <div class="form-group">
                <label for="ban-duration">Ban Duration</label>
                <select id="ban-duration" class="form-control">
                    <option value="1">1 Day</option>
                    <option value="3">3 Days</option>
                    <option value="7">7 Days</option>
                    <option value="30">30 Days</option>
                    <option value="permanent">Permanent</option>
                </select>
            </div>
            <div class="form-group">
                <label for="ban-reason">Reason (optional)</label>
                <textarea id="ban-reason" class="form-control" placeholder="Enter reason for ban"></textarea>
            </div>
            <div class="modal-buttons">
                <button id="confirm-ban" class="btn ban-btn">Ban User</button>
                <button id="cancel-ban" class="btn cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Unban Modal -->
    <div id="unban-modal" class="modal">
        <div class="modal-content animate-slide-up">
            <h2>Unban User</h2>
            <p id="unban-message">Are you sure you want to unban this user?</p>
            <div class="modal-buttons">
                <button id="confirm-unban" class="btn save-btn">Unban User</button>
                <button id="cancel-unban" class="btn cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Success Notification -->
    <div id="success-notification" class="notification">
        <div class="success-animation">
            <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
                <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
            </svg>
        </div>
        <p id="success-message">Operation successful!</p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="script.js"></script>
    <script>
        // Admin-specific JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            // Admin login
            document.getElementById('login-admin').addEventListener('click', function() {
                const password = document.getElementById('admin-password').value;
                if (password === "admin123") {
                    localStorage.setItem('isAdmin', 'true');
                    document.getElementById('admin-login').style.display = 'none';
                    document.querySelector('.admin-dashboard').classList.remove('hidden');
                    initAdminDashboard();
                    showSuccess('Login successful');
                } else {
                    alert('Incorrect password');
                }
            });

            // Check if already logged in
            if (localStorage.getItem('isAdmin') === 'true') {
                document.getElementById('admin-login').style.display = 'none';
                document.querySelector('.admin-dashboard').classList.remove('hidden');
                initAdminDashboard();
            }

            // Navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const sectionId = this.getAttribute('data-section');
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    document.getElementById(sectionId).classList.add('active');
                });
            });

            // Logout
            document.getElementById('logout-admin').addEventListener('click', function() {
                localStorage.removeItem('isAdmin');
                window.location.reload();
            });
        });

        function initAdminDashboard() {
            // Load settings
            loadSettings();
            
            // Load messages
            loadAdminMessages();
            
            // Load accounts
            loadAccounts();
            
            // Set up event listeners
            document.getElementById('admin-send-btn').addEventListener('click', sendAdminMessage);
            document.getElementById('admin-message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendAdminMessage();
                }
            });
            
            document.getElementById('save-settings').addEventListener('click', saveSettings);
            document.getElementById('search-accounts').addEventListener('input', searchAccounts);

            // Ban modal handlers
            document.getElementById('cancel-ban').addEventListener('click', () => {
                document.getElementById('ban-modal').style.display = 'none';
            });

            document.getElementById('cancel-unban').addEventListener('click', () => {
                document.getElementById('unban-modal').style.display = 'none';
            });
        }

        let currentBanUsername = null;

        function loadSettings() {
            firebase.database().ref('settings').once('value').then(snapshot => {
                const settings = snapshot.val() || {};
                
                if (settings.groupName) {
                    document.getElementById('group-name-input').value = settings.groupName;
                }
                
                if (settings.groupProfileUrl) {
                    document.getElementById('group-profile-url').value = settings.groupProfileUrl;
                }
                
                if (settings.chatStatus) {
                    document.querySelector(`input[name="chat-status"][value="${settings.chatStatus}"]`).checked = true;
                }
            });
        }

        function saveSettings() {
            const groupName = document.getElementById('group-name-input').value;
            const groupProfileUrl = document.getElementById('group-profile-url').value;
            const chatStatus = document.querySelector('input[name="chat-status"]:checked').value;
            
            firebase.database().ref('settings').set({
                groupName: groupName,
                groupProfileUrl: groupProfileUrl,
                chatStatus: chatStatus
            }).then(() => {
                showSuccess('Settings saved successfully');
            });
        }

        function loadAdminMessages() {
            firebase.database().ref('messages').orderByChild('timestamp').on('value', (snapshot) => {
                const messages = [];
                snapshot.forEach((childSnapshot) => {
                    const message = childSnapshot.val();
                    message.id = childSnapshot.key;
                    messages.push(message);
                });
                
                displayAdminMessages(messages);
            });
        }

        function displayAdminMessages(messages) {
            const chatMessages = document.getElementById('admin-chat-messages');
            chatMessages.innerHTML = '';
            
            messages.forEach((msg, index) => {
                if (msg.deleted) {
                    const deletedMsg = document.createElement('div');
                    deletedMsg.classList.add('message', 'admin-message', 'deleted-message');
                    deletedMsg.innerHTML = `
                        <div class="message-content">
                            <p class="deleted-text"><i class="fas fa-trash"></i> Message deleted by admin</p>
                        </div>
                    `;
                    chatMessages.appendChild(deletedMsg);
                    return;
                }
                
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', 'admin-message');
                messageElement.style.animationDelay = `${index * 0.1}s`;
                
                messageElement.innerHTML = `
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">${msg.username}</span>
                            <div class="message-actions">
                                <button class="action-btn ban-btn" data-username="${msg.username}" title="Ban User">
                                    <i class="fas fa-ban"></i>
                                </button>
                                <button class="action-btn delete-btn" data-message-id="${msg.id}" title="Delete Message">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <p class="message-text">${msg.message}</p>
                        <span class="message-time">${formatTime(msg.timestamp)}</span>
                    </div>
                `;
                
                chatMessages.appendChild(messageElement);
            });
            
            // Add delete event listeners
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const messageId = this.getAttribute('data-message-id');
                    if (confirm('Are you sure you want to delete this message?')) {
                        firebase.database().ref('messages/' + messageId).update({
                            deleted: true
                        }).then(() => {
                            showSuccess('Message deleted');
                        });
                    }
                });
            });

            // Add ban event listeners
            document.querySelectorAll('.ban-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    currentBanUsername = username;
                    document.getElementById('ban-modal').style.display = 'flex';
                });
            });
            
            // Confirm ban
            document.getElementById('confirm-ban').addEventListener('click', function() {
                const duration = document.getElementById('ban-duration').value;
                const reason = document.getElementById('ban-reason').value.trim();
                
                if (currentBanUsername) {
                    let banData = {
                        username: currentBanUsername,
                        bannedAt: Date.now(),
                        message: reason || 'No reason provided'
                    };
                    
                    if (duration === 'permanent') {
                        banData.permanent = true;
                    } else {
                        const days = parseInt(duration);
                        const banDate = new Date();
                        banDate.setDate(banDate.getDate() + days);
                        banData.until = banDate.getTime();
                    }
                    
                    firebase.database().ref('bannedUsers/' + currentBanUsername).set(banData)
                        .then(() => {
                            document.getElementById('ban-modal').style.display = 'none';
                            document.getElementById('ban-reason').value = '';
                            showSuccess('User banned successfully');
                            loadAccounts();
                        });
                }
            });
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendAdminMessage() {
            const messageInput = document.getElementById('admin-message-input');
            const message = messageInput.value.trim();
            
            if (message) {
                const timestamp = Date.now();
                firebase.database().ref('messages/' + timestamp).set({
                    username: 'Admin',
                    message: message,
                    timestamp: timestamp
                }).then(() => {
                    showSuccess('Message sent');
                });
                messageInput.value = '';
            }
        }

        function loadAccounts() {
            // Load all unique usernames from messages and banned users
            Promise.all([
                firebase.database().ref('messages').once('value'),
                firebase.database().ref('bannedUsers').once('value')
            ]).then(([messagesSnapshot, bannedSnapshot]) => {
                const users = new Set();
                const bannedUsers = bannedSnapshot.val() || {};
                const bannedUsernames = Object.keys(bannedUsers);
                
                messagesSnapshot.forEach(childSnapshot => {
                    const message = childSnapshot.val();
                    if (!message.deleted) {
                        users.add(message.username);
                    }
                });
                
                displayAccounts(Array.from(users), bannedUsernames);
                document.getElementById('total-users').textContent = users.size;
                document.getElementById('active-users').textContent = Math.floor(users.size * 0.7);
                document.getElementById('banned-users').textContent = bannedUsernames.length;
            });
        }

        function displayAccounts(users, bannedUsernames) {
            const accountsList = document.getElementById('accounts-list');
            accountsList.innerHTML = '';
            
            users.forEach(user => {
                const isBanned = bannedUsernames.includes(user);
                
                const accountElement = document.createElement('div');
                accountElement.classList.add('account-item');
                if (isBanned) {
                    accountElement.classList.add('banned');
                }
                
                accountElement.innerHTML = `
                    <div class="account-info">
                        <div class="user-avatar">
                            <i class="fas fa-user${isBanned ? '-slash' : ''}"></i>
                        </div>
                        <div class="user-details">
                            <h4>${user} ${isBanned ? '<span class="banned-badge">BANNED</span>' : ''}</h4>
                            <p>Last active: Today</p>
                        </div>
                    </div>
                    <div class="account-actions">
                        ${isBanned ? 
                            `<button class="action-btn unban-btn" data-username="${user}">
                                <i class="fas fa-unlock"></i> Unban
                            </button>` : 
                            `<button class="action-btn ban-btn" data-username="${user}">
                                <i class="fas fa-ban"></i> Ban
                            </button>`
                        }
                        <button class="action-btn delete-btn" data-username="${user}">
                            <i class="fas fa-trash"></i> Delete All
                        </button>
                    </div>
                `;
                
                accountsList.appendChild(accountElement);
            });
            
            // Add ban event listeners
            document.querySelectorAll('.ban-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    currentBanUsername = username;
                    document.getElementById('ban-modal').style.display = 'flex';
                });
            });
            
            // Add unban event listeners
            document.querySelectorAll('.unban-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    currentBanUsername = username;
                    document.getElementById('unban-message').textContent = 
                        `Are you sure you want to unban ${username}?`;
                    document.getElementById('unban-modal').style.display = 'flex';
                });
            });
            
            // Confirm unban
            document.getElementById('confirm-unban').addEventListener('click', function() {
                if (currentBanUsername) {
                    firebase.database().ref('bannedUsers/' + currentBanUsername).remove()
                        .then(() => {
                            document.getElementById('unban-modal').style.display = 'none';
                            showSuccess('User unbanned successfully');
                            loadAccounts();
                        });
                }
            });
            
            // Add delete all messages event listeners
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    if (confirm(`Are you sure you want to delete all messages from ${username}?`)) {
                        firebase.database().ref('messages').orderByChild('username').equalTo(username).once('value')
                            .then(snapshot => {
                                const updates = {};
                                snapshot.forEach(child => {
                                    updates[child.key] = { deleted: true };
                                });
                                firebase.database().ref('messages').update(updates)
                                    .then(() => {
                                        showSuccess(`All messages from ${username} have been deleted`);
                                        loadAdminMessages();
                                    });
                            });
                    }
                });
            });
        }

        function searchAccounts() {
            const searchTerm = document.getElementById('search-accounts').value.toLowerCase();
            document.querySelectorAll('.account-item').forEach(item => {
                const username = item.querySelector('h4').textContent.toLowerCase();
                if (username.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function showSuccess(message) {
            const notification = document.getElementById('success-notification');
            document.getElementById('success-message').textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>